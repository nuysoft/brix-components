define("components/datepickerwrapper",["jquery","underscore","moment","brix/loader","components/base","brix/event","components/datepicker"],function(t,e,i,n,a,s,r){return function(t){function e(n){if(i[n])return i[n].exports;var a=i[n]={exports:{},id:n,loaded:!1};return t[n].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){var n,a;n=[i(1),i(2),i(3),i(4),i(5),i(6),i(7),i(8),i(9)],a=function(t,e,i,n,a,s,r,o,c){function d(){}var l=/^input|textarea$/i,p=".datepickerwrapper",h=r.DATE_PATTERN,u=r.TIME_PATTERN,f=r.DATE_TIME_PATTERN,m=function(){var t=i(),e=t.get("date"),n={"今天":[i().startOf("day"),i().startOf("day")],"昨天":[i().startOf("day").subtract(1,"days"),i().startOf("day").subtract(1,"days")],"过去 7 天":[i().startOf("day").subtract(7,"days"),i().startOf("day").subtract(1,"days")],"本月":[i().startOf("day").subtract(e-1,"days"),i().startOf("day")],"上月":[i().startOf("day").startOf("month").subtract(1,"month"),i().startOf("day").startOf("month").subtract(1,"days")],"最近 15 天":[i().startOf("day").subtract(15,"days"),i().startOf("day").subtract(1,"days")]};return n}(),v={PENDING:"pending",ACTIVE:"active",INACTIVE:"inactive"};return d.DATE_PATTERN=h,d.TIME_PATTERN=u,d.DATE_TIME_PATTERN=f,d.SHORTCUTS=m,e.extend(d.prototype,a.prototype,{options:{placement:"bottom",align:"left",offset:{},mode:"signal",shortcuts:m,type:"date",dates:[],ranges:[],excludeds:[],unlimits:[]},init:function(){this.options.typeMap=r.typeMap(this.options.type),this.options.dates.length>1&&(this.options.mode="multiple"),this.options.dates.length||(this.options.dates=[i().startOf("day").format(h)]),this.options.shortcuts&&e.each(this.options.shortcuts,function(t){e.each(t,function(n,a){t[a]=i(n,e.isString(n)&&f)})}),this.options.range&&this.options.range.length&&(this.options.ranges=this.options.range),this.options.ranges=e.flatten(this.options.ranges||this.options.range),e.each(this.options.ranges,function(t,n,a){t&&(a[n]=i(t,e.isString(t)&&f))}),this.options._ranges=e.map(this.options.ranges,function(t){if(t)return t.format(h)}),this.options._ranges="['"+this.options._ranges.join("','")+"']",this.options.excluded&&this.options.excluded.length&&(this.options.excludeds=this.options.excluded),this.options.excludeds=e.flatten(this.options.excludeds||this.options.excluded),e.each(this.options.excludeds,function(t,n,a){t&&(a[n]=i(t,e.isString(t)&&f))}),this.options._excludeds=e.map(this.options.excludeds,function(t){if(t)return t.format(h)}),this.options._excludeds=this.options._excludeds.length?"['"+this.options._excludeds.join("','")+"']":"[]",c=this.options.template||c,this.options.css&&window.require("css!"+this.options.css)},render:function(){var i=this;this.$element=t(this.element),this.$relatedElement=t(e.template(c)(this.options)).insertAfter(this.$element);var n=t.Deferred();this["_"+this.options.mode](n);var a="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(a).on(a,function(t){i.toggle(t)});var r=this.$manager=new s("bx-");return r.delegate(this.$element,this),r.delegate(this.$relatedElement,this),this._autoHide(),n.promise()},val:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(e.each(i,function(i,n){i.val(e.isArray(t)?t[n]:t)}),this.submit(),this):e.map(i,function(t){return t.val()})},range:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.ranges=t=e.flatten(t),e.each(i,function(e){e.range(t)}),this):this.options.ranges},excluded:function(t){var i=n.query("components/datepicker",this.$relatedElement);return t?(this.options.excludeds=t=e.flatten(t),e.each(i,function(e){e.excluded(t)}),this):this.options.excludeds},_signal:function(i){var a=this;n.boot(!0,this.$relatedElement,function(){var s=n.query("components/datepicker",a.$relatedElement)[0];s.on("change.datepicker unchange.datepicker",function(i,n,s){if(!n)return i.preventDefault(),void i.stopPropagation();if(!(void 0!==s&&"date"!==s&&"time"!==s||a.options.typeMap.time&&"date"===s)){a.hide();var r=t.Event("change"+p);if(a.trigger(r,[[n],s]),!r.isDefaultPrevented()){var o=a._unlimitFilter(n,a.options.unlimits[0]),c=t("[data-index]",a.$element);c.length?e.each(c,function(e,i){var n=t(e);n[l.test(e.nodeName)?"val":"html"](o)}):a.$element[l.test(a.element.nodeName)?"val":"html"](o),a.$element.triggerHandler("change"),l.test(a.element.nodeName)||t("[data-hidden-index]",a.$element).val(o).triggerHandler("change")}}}),s.$element.on("click",".timepicker .timepicker-footer .cancel",function(){a.hide()}),i&&i.resolve()})},_multiple:function(a){var s=this;n.boot(!0,this.$relatedElement,function(){var r=t(".datepickerwrapper-inputs",s.$relatedElement),o=t("input",r),c=t(".datepickerwrapper-pickers",s.$relatedElement),d=t(".picker",c),l=n.query("components/datepicker",s.$relatedElement),p=t(".datepickerwrapper-shortcuts",s.$relatedElement),u=t(".shortcut",p);s.options.shortcuts&&e.each(e.values(s.options.shortcuts),function(t,n){var a=!0;e.each(t,function(t,n){var r=i(s.options.dates[n],e.isString(s.options.dates[n])&&f);t.isSame(r,"days")||(a=!1)}),a&&u.eq(n).addClass("active").siblings().removeClass("active")}),e.each(o,function(n,a){t(n).val(i(s.options.dates[a],e.isString(s.options.dates[a])&&f).format(h))}),e.each(l,function(t,n){t.val(s.options.dates[n]).on("change.datepicker unchange.datepicker ",function(t,e,i){if(!(void 0!==i&&"date"!==i&&"time"!==i||s.options.typeMap.time&&"date"===i)){var a=s._unlimitFilter(e,s.options.unlimits[n]);o.eq(n).val(a),d.eq(n).hide()}});var a=s._unlimitFilter(i(s.options.dates[n],e.isString(s.options.dates[n])&&f),s.options.unlimits[n]);o.eq(n).val(a),t.$element.on("click",".timepicker .timepicker-footer .cancel",function(){d.eq(n).hide()})}),a&&a.resolve()})},_unlimitFilter:function(t,n){var a=this.options.typeMap,s=a.date&&a.time&&f||a.date&&h||a.time&&u,r=t.format(s);return n&&r===i(n,e.isString(n)&&f).format(s)&&(r="不限"),r},_inputToggleDatePicker:function(e,i,n){var a=t(".datepickerwrapper-inputs",this.$relatedElement),s=t(".datepickerwrapper-pickers",this.$relatedElement),r=t(".picker",s),o=a.offset();s.offset({left:o.left,top:o.top+a.outerHeight()+(parseInt(s.css("margin-top"),10)||0)});var c,d=r.eq(i),l=t(e.target),p=l.offset();switch(this.options.align){case"left":c=p.left;break;case"right":c=p.left-(d.outerWidth()-l.outerWidth())}d[n?n:"toggle"]().offset({left:c}).siblings().hide()},_hideDatePicker:function(){var e=t(".datepickerwrapper-pickers",this.$relatedElement),i=t(".picker",e);i.hide()},show:function(){this.$element.addClass("datepickerwrapper-open"),this.$relatedElement.show().offset(this._offset())},hide:function(){this.$element.removeClass("datepickerwrapper-open"),this._hideDatePicker(),this.$relatedElement.hide()},toggle:function(){this.$element.toggleClass("datepickerwrapper-open"),this.$relatedElement.toggle().offset(this._offset())},_offset:function(){var t=o(this.$element,this.$relatedElement,this.options.placement,this.options.align),e=parseInt(this.$relatedElement.css("margin-left"),10)||0,i=parseInt(this.$relatedElement.css("margin-top"),10)||0;return{left:t.left+e+(this.options.offset.left||0),top:t.top+i+(this.options.offset.top||0)}},submit:function(i,a){var s=this;switch(a){case"shortcut":break;default:var r=t(".datepickerwrapper-shortcuts",s.$relatedElement),o=t(".shortcut",r);o.removeClass("active")}var c=n.query("components/datepicker",this.$relatedElement),d=e.map(c,function(t){return t.val()});this.hide();var h=t.Event("change"+p);if(this.trigger(h,[d]),!h.isDefaultPrevented()){var u=t("[data-index]",this.$element);u.length?e.each(u,function(e,i){var n=t(e);i=+n.attr("data-index"),n[l.test(e.nodeName)?"val":"html"](s._unlimitFilter(d[i],s.options.unlimits[i]))}):this.$element[l.test(this.element.nodeName)?"val":"html"](e.map(d,function(t,e){return s._unlimitFilter(t,s.options.unlimits[e])}).join(", ")),u=t("[data-hidden-index]",this.$element),e.each(u,function(e,i){var n=t(e);i=+n.attr("data-hidden-index");var a=s._unlimitFilter(d[i],void 0);n.val(a).trigger("change")})}},shortcutText:function(t){var i;return e.each(this.options.shortcuts,function(n,a){if(!i){var s=!0;e.each(n,function(e,i){e.isSame(t[i],"days")||(s=!1)}),s&&(i=a)}}),i},_change:function(a,s,r){var o=this,c=t(a.target),d=n.query("components/datepicker",this.$relatedElement);switch(s){case"shortcut":var l=c.attr("data-value").split(",");e.each(l,function(t,e){o.options.dates[e]=t,d[e].val(t)}),c.addClass("active").siblings().removeClass("active"),this.submit(a,s);break;case"date":var p=i(c.val());if(!p.isValid())break;d[r].val(p)}},_autoHide:function(){var e=this,i="click"+p+"_"+this.clientId;this._state=v.INACTIVE,t(document.body).off(i).on(i,function(i){if(t.contains(document.body,i.target)){if(i.target===e.element||t.contains(e.element,i.target)||i.target===e.$relatedElement[0]||t.contains(e.$relatedElement[0],i.target)){if(e._state===v.ACTIVE)return;return e.trigger(t.Event("active"+p,{target:i.target})),void(e._state=v.ACTIVE)}if(e._state!==v.INACTIVE){var n=t.Event("inactive"+p,{target:i.target});e.trigger(n),e._state=v.INACTIVE,n.isDefaultPrevented()||e.hide()}}}).on(i,function(i){var n=t(".datepickerwrapper-inputs-body",e.$relatedElement),a=t(".datepickerwrapper-pickers",e.$relatedElement);i.target!==e.$relatedElement[0]&&!t.contains(e.$relatedElement[0],i.target)||!n.length||!a.length||t.contains(n[0],i.target)||t.contains(a[0],i.target)||e._hideDatePicker()})},destroy:function(){var e="click.datepickerwrapper_toggle_"+this.clientId;this.$element.off(e),this.$manager.undelegate(this.$element,this),this.$manager.undelegate(this.$relatedElement,this),this.$relatedElement.remove(),e="click"+p+"_"+this.clientId,t(document.body).off(e)}}),d}.apply(e,n),!(void 0!==a&&(t.exports=a))},function(e,i){e.exports=t},function(t,i){t.exports=e},function(t,e){t.exports=i},function(t,e){t.exports=n},function(t,e){t.exports=a},function(t,e){t.exports=s},function(t,e){t.exports=r},function(t,e,i){var n,a;n=[i(1)],a=function(t){function e(e,n,a,o){var c=t(e);if(!c.length)return i(n);var d=c.offset(),l=d.left,p=d.top,h=c.outerWidth(),u=c.outerHeight(),f=t(n),m="none"!==f.css("display");f.show();var v=f.outerWidth(),g=f.outerHeight();m||f.hide();var k,y,b=h/2-v/2,x=u/2-g/2;switch(a){case"top":k=l+b,y=p-g;break;case"bottom":k=l+b,y=p+u;break;case"left":k=l-v,y=p+x;break;case"right":k=l+h,y=p+x}if(s.test(a)!==s.test(o)&&r.test(a)!==r.test(o))switch(o){case"top":y=p;break;case"bottom":y=p+u-g;break;case"left":k=l;break;case"right":k=l+h-v}return{left:k,top:y}}function i(e,i){var n,a;if(i)n=parseFloat(e,12),a=parseFloat(i,12);else{var s=t(e),r="none"!==s.css("display");s.show(),n=s.outerWidth(),a=s.outerHeight(),r||s.hide()}var o=t(window),c=o.width(),d=o.height(),l=o.scrollLeft(),p=o.scrollTop();return{left:c/2-n/2+l,top:d/2-a/2+p}}function n(e,i,n){var a=t(e),s="none"!==a.css("display");a.show();var r=a.outerWidth(),o=a.outerHeight();s||a.hide();var c={opacity:0,left:i.left,top:i.top};switch(n){case"top":c.top=c.top-.5*o;break;case"bottom":c.top=c.top+.5*o;break;case"left":c.left=c.left-.5*r;break;case"right":default:c.left=c.left+.5*r}return c}function a(t,e){return{opacity:1,left:e.left,top:e.top}}var s=/top|bottom/,r=/left|right/;return e.center=i,e.start=n,e.end=a,e}.apply(e,n),!(void 0!==a&&(t.exports=a))},function(t,e,i){var n;n=function(){return"<div class=\"datepickerwrapper <%= mode === 'multiple' ? 'multiple' : 'single' %>\">\n    <!--  -->\n    <% if (mode === 'signal') { %>\n"+'    <div bx-name="components/datepicker" data-type="<%= type %>" data-date="<%= dates[0] %>" data-range="<%= _ranges %>" data-excluded="<%= _excludeds %>" data-unlimit="<%= unlimits[0] %>" class="picker"></div>\n    <% } %>\n    <!--  -->\n    <% if (mode === \'multiple\') { %>\n    <% if( shortcuts ) { %>\n    <div class="datepickerwrapper-shortcuts form-inline form-group">\n        <div class="datepickerwrapper-shortcuts-header">\n            <div class="datepickerwrapper-shortcuts-header-title">快捷日期</div>\n        </div>\n        <div class="datepickerwrapper-shortcuts-body clearfix">\n            <% for (var title in shortcuts) { %>\n                <span bx-click="_change(\'shortcut\')" data-value="<%= \n                    _.map(shortcuts[title], function(item) {\n                        return item.format(\'YYYY-MM-DD HH:mm:ss\')\n                    }).join(\',\')\n                %>" class="shortcut"><%= title %></span>\n            <% } %>\n        </div>\n    </div>\n    <% } %>\n    <div class="datepickerwrapper-inputs form-inline form-group">\n        <div class="datepickerwrapper-inputs-header">\n            <div class="datepickerwrapper-inputs-header-title">日期范围</div>\n        </div>\n        <div class="datepickerwrapper-inputs-body <%= typeMap.time ? \'time\' : \'\' %>">\n            <% for (var i = 0; i < dates.length; i++ ) { %>\n                <input bx-click="_inputToggleDatePicker(<%= i %>)" bx-change="_change(\'date\', <%= i %>)" value="<%= dates[i] %>" type="text" class="form-control">\n                <%= i < dates.length -1 ? \'-\' : \'\' %>\n            <% } %>\n        </div>\n    </div>\n    <div class="datepickerwrapper-pickers">\n        <% for (var i = 0; i < dates.length; i++ ) { %>\n            <div bx-name="components/datepicker" data-date="<%= dates[i] %>" data-range="<%= _ranges %>" data-excluded="<%= _excludeds %>" data-unlimit="<%= unlimits[i] %>" data-type="<%= type %>" class="picker"></div>\n        <% } %>\n    </div>\n    <div class="datepickerwrapper-footer">\n        <button class="btn btn-default submit" bx-click="submit">确认</button>\n        <a href="javascript: void(0);" bx-click="hide" class="btn btn-default cancel ml5">取消</a>\n    </div>\n    <% } %>\n</div>'}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))}])});