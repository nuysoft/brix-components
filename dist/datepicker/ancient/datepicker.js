define(["jquery","underscore","moment","components/base","brix/event","./datepicker.tpl.js"],function(t,e,a,i,n,r){function s(){}var d=".datepicker",o="second minute hour time date month year",h="YYYY",c="YYYY-MM",_="YYYY-MM-DD",u="HH:mm:ss",m=_+" "+u,l=e.template('_active("<%= value %>", "<%= unit %>", "<%= pattern %>")'),f=20,p=/^([+-])=(.+)/,g=e.map(e.range(1,13),function(t){return(10>t?"0":"")+t});return s.NAMESPACE=d,s.TYPES=o,s.DATE_PATTERN=_,s.TIME_PATTERN=u,s.DATE_TIME_PATTERN=m,s.typeMap=function(t){-1!==e.indexOf(["all","",void 0],t)&&(t=o);var a={};return e.each(t.split(/\s+/),function(t){a[t]=!0}),a.time=a.time||a.hour||a.minute||a.second,a},e.extend(s.prototype,i.prototype,{options:{date:a(),type:"all",range:[],excluded:[],unlimit:!1,pages:1,mode:""},init:function(){this.options.range=e.flatten(this.options.range),this.options.excluded=e.flatten(this.options.excluded),this.options.unlimit&&(this.options.unlimit=a(this.options.unlimit,e.isString(this.options.unlimit)&&m)),this.data=this.data||{},this.data.options=this.options,this.data.moment=a,this.data.date=a(this.options.date,e.isString(this.options.date)&&m),this.options.unlimit&&this.options.unlimit.isSame(this.data.date)&&(this.__unlimit=this.options.unlimit),this.data.typeMap=s.typeMap(this.options.type)},render:function(){this.$element=t(this.element).append(e.template(r)(this.data));var a=this.$manager=new n("bx-");a.delegate(this.$element,this),this._renderYearPicker()._renderMonthPicker()._renderDatePicker()._renderTimePicker()},val:function(i){if(i){this.__unlimit=!1;var n=a(i,e.isString(i)&&m),r=n.isSame(this.data.date),s=t.Event((r?"unchange":"change")+d);return this.trigger(s,a(this.data.date)),event.isDefaultPrevented()?this:(r||(this.data.date=n,this._renderYearPicker()._renderMonthPicker()._renderDatePicker()._renderTimePicker()),this)}return a(this.__unlimit||this.data.date)},range:function(t){return t?(this.options.range=e.flatten(t),this._renderDatePicker(),this):this.options.range},excluded:function(t){return t?(this.options.excluded=e.flatten(t),this._renderDatePicker(),this):this.options.excluded},_slide:function(e,a,i){if(e.target){var n=t(e.target).parents(".year-month-date"),r=n.siblings();r.find(".year").slideUp("fast"),r.find(".month").slideUp("fast"),r.find(".date").slideDown("fast")}var s=e.target?t(e.target).parents(".year-month-date"):this.$element.find(".year-month-date");e.target||(i=a,a=e),s.find(a).slideUp("fast"),s.find(i).slideDown("fast")},_move:function(e,i,n){var r=this.__isUnlimitMode();r&&(this.data.date=a().startOf("day")),this.__unlimit=!1;var s=a(this.data.date),o=this.data.date;if("period"===i)return void this._renderYearPicker(n);o.add(n,i);var h=o.isSame(s),c=t.Event((h?"unchange":"change")+d);if(this.trigger(c,[a(o),i]),c.isDefaultPrevented())return this;if(!h)switch(i){case"period":this._renderYearPicker(n);break;case"year":this._renderMonthPicker();break;case"month":this._renderDatePicker()._renderMonthPicker()}},_moveYearPicker:function(e,i){var n=t(e.currentTarget).parents("[data-page]").data("page"),r=t(e.currentTarget).parents(".year-header").data("date");r=a(r,h).add(i*f,"years"),this._renderYearPicker(r,n,!1)},_moveMonthPicker:function(e,i){var n=t(e.currentTarget).parents("[data-page]").data("page"),r=t(e.currentTarget).parents(".month-header").data("date");r=a(r,c).add(i,"years"),this._renderMonthPicker(r,n,!1)},_moveDatePicker:function(e,i){var n=t(e.target).parents(".year-month-date"),r=n.siblings();r.find(".year").slideUp("fast"),r.find(".month").slideUp("fast"),r.find(".date").slideDown("fast");var s=t(e.currentTarget).parents("[data-page]").data("page"),d=t(e.currentTarget).parents(".date-header").data("date");d=a(d,c).add(i,"months"),this._renderDatePicker(d,s,!1)},_active:function(i,n,r,s){i.preventDefault(),this.__cursor=t(i.currentTarget).parents("[data-page]").data("page");var o=this.__isUnlimitMode();o&&(this.data.date=a().startOf("day")),this.__unlimit=!1;var h=a(this.data.date),c=this.data.date,_=a(n,s);switch(r){case"date":c.date(_.date()).month(_.month()).year(_.year());break;case"month":c.month(_.month()).year(_.year());break;case"year":c.year(_.year())}var u=c.isSame(h),m=t.Event((u?"unchange":"change")+d);if(this.trigger(m,[a(c),r]),!m.isDefaultPrevented())switch(this.$element.find(e.template(".<%= obj %>-body-content span")(r)).removeClass("active"),t(i.currentTarget).addClass("active"),r){case"date":this._renderMonthPicker()._renderYearPicker();break;case"month":if(this.data.typeMap.month)break;this._slide(i,".month",".date"),this._renderDatePicker();break;case"year":if(this.data.typeMap.year)break;this._slide(i,".year",".month"),this._renderMonthPicker()._renderDatePicker()}},_hooks:{38:1,40:-1},_changeTime:function(e,i,n,r){this.__unlimit=!1;var s=this.data.date;if(void 0===i&&void 0===n&&void 0===r){var o=t.Event("change"+d);return void this.trigger(o,[a(s),"time"])}var h=s.toDate().getTime();if("keydown"===e.type){if(!this._hooks[e.which])return;i=this._hooks[e.which]||0}("blur"===e.type||"focusout"===e.type)&&(this.data.date.set(n,e.target.value),i=0),s.add(i,r),e.preventDefault(),e.stopPropagation();var c=s.toDate().getTime()===h,_=t.Event((c?"unchange":"change")+d);this.trigger(_,[a(s),n]),c||this._renderTimePicker()._renderYearPicker()._renderMonthPicker()._renderDatePicker()},_changeHour:function(t,e){this._changeTime(t,e,"hour","hours")},_changeMinute:function(t,e){this._changeTime(t,e,"minute","minutes")},_changeSecond:function(t,e){this._changeTime(t,e,"second","seconds")},__isUnlimitMode:function(){return this.options.unlimit&&(this.__unlimit||this.options.unlimit.isSame(this.data.date))&&!0||!1},_renderYearPicker:function(i,n,r){i=i||this.data.date||a(),n=n||this.__cursor||0;var s=this,d=this.options.range,o=this.__isUnlimitMode();o&&(i=a().startOf("day"));var h=this.$element.find(".year");return e.each(h,function(e,o){var h=t(e),c=a(i).add(o-n,"months"),_=h.data(),u=c.year();_.start=u-u%f,_.end=_.start+f-1,s.__renderYearPickerTitle(h,c),s.__renderYearPickerContent(h,i,c,d,r)}),this},__renderYearPickerTitle:function(t,e){var a=t.data();t.find(".year-header").data("date",e.format(h)).find(".year-header-title").text(a.start+" - "+a.end)},__renderYearPickerContent:function(e,i,n,r,s){for(var d=this.__isUnlimitMode(),o=e.find(".year-body .year-body-content").empty(),c=e.data(),_=c.start;_<=c.end;_++)n.year(_),t("<span>").text(_).attr("data-value",_).addClass(n.isSame(a(),"year")?"hover":"").addClass(s!==!1&&!d&&n.isSame(i,"year")?"active":"").addClass(this.__disabled(n,"year")?"disabled":"").attr("bx-click",l({unit:"year",value:n.format(h),pattern:h})).appendTo(o)},_renderMonthPicker:function(i,n,r){i=i||this.data.date||a(),n=n||this.__cursor||0;var s=this,d=this.options.range,o=this.__isUnlimitMode();o&&(i=a().startOf("day"));var h=this.$element.find(".month");return e.each(h,function(e,o){var h=t(e),c=a(i).add(o-n,"months");s.__renderMonthPickerTitle(h,c),s.__renderMonthPickerContent(h,i,c,d,r)}),this},__renderMonthPickerTitle:function(t,e){t.find(".month-header").data("date",e.format(h)).find(".month-header-title").text(e.format(h))},__renderMonthPickerContent:function(i,n,r,s,d){var o=this,h=this.__isUnlimitMode(),_=i.find(".month-body .month-body-content").empty();e.each(g,function(e,i){r.month(i),t("<span>").text(e).attr("data-value",r.format(c)).addClass(r.isSame(a(),"month")?"hover":"").addClass(d!==!1&&!h&&r.isSame(n,"month")?"active":"").addClass(o.__disabled(r,"month")?"disabled":"").attr("bx-click",l({unit:"month",value:r.format(c),pattern:c})).appendTo(_)})},_renderDatePicker:function(i,n,r){i=void 0!==i?data:this.data.date||a(),n=void 0!==n?n:this.__cursor||0;var s=this,d=(this.options.range,this.__isUnlimitMode());d&&(i=a().startOf("day"));var o=this.$element.find(".date");return e.each(o,function(e,d){var o=t(e),h=a(i).add(d-n,"months");s.__renderDatePickerTitle(o,h),s.__renderDatePickerContent(o,i,h,r)}),this},__renderDatePickerTitle:function(t,e){t.find(".date-header").data("date",e.format(c)).find(".date-header-title").text(e.format("YYYY - MM"))},__renderDatePickerContent:function(e,i,n,r){for(var s=(this.options.range,this.options.excluded,this.__isUnlimitMode()),d=e.find(".date-body .date-body-content").empty(),o=a(n).date(1).day(),h=0;o>h;h++)d.append('<span class="inactive">');for(var c=n.daysInMonth(),u=1;c>=u;u++)n.date(u),t("<span>").text(u).addClass(n.isSame(a(),"day")?"hover":"").addClass(r!==!1&&!s&&n.isSame(i,"day")?"active":"").addClass(this.__disabled(n,"day")?"disabled":"").attr("bx-click",l({unit:"date",value:n.format(_),pattern:_})).appendTo(d)},__disabled:function(t,e){var a=this.options.range,i=this.options.excluded;switch(e){case"year":return!this.__inRange(t,a,e);case"month":return!this.__inRange(t,a,e);case"day":return!this.__inRange(t,a,e)||this.__inExcluded(t,i,e)}},__inRange:function(t,e,a){return this.__in(t,e,a,!0)},__inExcluded:function(t,e,a){return this.__in(t,e,a,!1)},__in:function(t,i,n,r){if(!i.length)return r;for(var s,d,o,h=0;h<i.length;h+=2){if(s=i[h]&&(e.isString(i[h])&&(o=p.exec(i[h]))?a().add((o[1]+1)*o[2],"day"):a(i[h],e.isString(i[h])&&m)),d=i[h+1]&&(e.isString(i[h+1])&&(o=p.exec(i[h+1]))?a().add((o[1]+1)*o[2],"day"):a(i[h+1],e.isString(i[h+1])&&m)),s&&d){var c=[a.min(s,d),a.max(s,d)];s=c[0],d=c[1]}if((!s||t.isSame(s,n)||t.isAfter(s,n))&&(!d||t.isSame(d,n)||t.isBefore(d,n)))return!0}return!1},_renderTimePicker:function(){var t=a(this.data.date),e=this.$element.find(".hour-minute-second input");return e.eq(0).val(t.format("HH")),e.eq(1).val(t.format("mm")),e.eq(2).val(t.format("ss")),this},_unlimit:function(){var e=this.options.unlimit;this.__unlimit=e;var a=e.isSame(this.data.date),i=t.Event((a?"unchange":"change")+d);this.trigger(i,[e,"date"]),this._renderYearPicker()._renderMonthPicker()._renderDatePicker()},destroy:function(){this.$manager.undelegate(this.$element,this)}}),s});