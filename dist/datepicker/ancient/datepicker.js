define(["jquery","underscore","moment","components/base","brix/event","./datepicker.tpl.js"],function(t,e,i,a,n,r){function s(){}var d=".datepicker",o="second minute hour time date month year",h="YYYY",c="YYYY-MM",u="YYYY-MM-DD",m="HH:mm:ss",f=u+" "+m,l=e.template('_active("<%= value %>", "<%= unit %>", "<%= pattern %>")'),p=20;return s.NAMESPACE=d,s.TYPES=o,s.DATE_PATTERN=u,s.TIME_PATTERN=m,s.DATE_TIME_PATTERN=f,s.typeMap=function(t){-1!==e.indexOf(["all","",void 0],t)&&(t=o);var i={};return e.each(t.split(/\s+/),function(t){i[t]=!0}),i.time=i.time||i.hour||i.minute||i.second,i},e.extend(s.prototype,a.prototype,{options:{date:i(),type:"all",range:[],unlimit:!1,pages:1,mode:""},init:function(){this.options.range=e.flatten(this.options.range),this.options.unlimit&&(this.options.unlimit=i(this.options.unlimit,e.isString(this.options.unlimit)&&f)),this.data=this.data||{},this.data.options=this.options,this.data.moment=i,this.data.date=i(this.options.date,e.isString(this.options.date)&&f),this.options.unlimit&&this.options.unlimit.isSame(this.data.date)&&(this.__unlimit=this.options.unlimit),this.data.typeMap=s.typeMap(this.options.type)},render:function(){this.$element=t(this.element).append(e.template(r)(this.data));var i=this.$manager=new n("bx-");i.delegate(this.$element,this),this._renderYearPicker()._renderMonthPicker()._renderDatePicker()._renderTimePicker()},val:function(a){if(a){this.__unlimit=!1;var n=i(a,e.isString(a)&&f),r=n.isSame(this.data.date),s=t.Event((r?"unchange":"change")+d);return this.trigger(s,i(this.data.date)),event.isDefaultPrevented()?this:(r||(this.data.date=n,this._renderYearPicker()._renderMonthPicker()._renderDatePicker()._renderTimePicker()),this)}return i(this.__unlimit||this.data.date)},range:function(t){return t?(this.options.range=e.flatten(t),this._renderDatePicker(),this):this.options.range},not:function(){},_slide:function(e,i,a){if(e.target){var n=t(e.target).parents(".year-month-date"),r=n.siblings();r.find(".year").slideUp("fast"),r.find(".month").slideUp("fast"),r.find(".date").slideDown("fast")}var s=e.target?t(e.target).parents(".year-month-date"):this.$element.find(".year-month-date");e.target||(a=i,i=e),s.find(i).slideUp("fast"),s.find(a).slideDown("fast")},_move:function(e,a,n){var r=this.__isUnlimitMode();r&&(this.data.date=i().startOf("day")),this.__unlimit=!1;var s=i(this.data.date),o=this.data.date;if("period"===a)return void this._renderYearPicker(n);o.add(n,a);var h=o.isSame(s),c=t.Event((h?"unchange":"change")+d);if(this.trigger(c,[i(o),a]),c.isDefaultPrevented())return this;if(!h)switch(a){case"period":this._renderYearPicker(n);break;case"year":this._renderMonthPicker(n);break;case"month":this._renderDatePicker(n)._renderMonthPicker()}},_active:function(a,n,r,s){a.preventDefault(),this.__cursor=t(a.currentTarget).parents("[data-group-page]").attr("data-group-page");var o=this.__isUnlimitMode();o&&(this.data.date=i().startOf("day")),this.__unlimit=!1;var h=i(this.data.date),c=this.data.date,u=i(n,s);switch(r){case"date":c.date(u.date()).month(u.month()).year(u.year());break;case"month":c.month(u.month()).year(u.year());break;case"year":c.year(u.year())}var m=c.isSame(h),f=t.Event((m?"unchange":"change")+d);if(this.trigger(f,[i(c),r]),!f.isDefaultPrevented())switch(this.$element.find(e.template(".<%= obj %>-body-content span")(r)).removeClass("active"),t(a.currentTarget).addClass("active"),r){case"date":this._renderMonthPicker()._renderYearPicker();break;case"month":if(this.data.typeMap.month)break;this._slide(a,".month",".date"),this._renderDatePicker();break;case"year":if(this.data.typeMap.year)break;this._slide(a,".year",".month"),this._renderMonthPicker()._renderDatePicker()}},_hooks:{38:1,40:-1},_changeTime:function(e,a,n,r){this.__unlimit=!1;var s=this.data.date;if(void 0===a&&void 0===n&&void 0===r){var o=t.Event("change"+d);return void this.trigger(o,[i(s),"time"])}var h=s.toDate().getTime();if("keydown"===e.type){if(!this._hooks[e.which])return;a=this._hooks[e.which]||0}("blur"===e.type||"focusout"===e.type)&&(this.data.date.set(n,e.target.value),a=0),s.add(a,r),e.preventDefault(),e.stopPropagation();var c=s.toDate().getTime()===h,u=t.Event((c?"unchange":"change")+d);this.trigger(u,[i(s),n]),c||this._renderTimePicker()._renderYearPicker()._renderMonthPicker()._renderDatePicker()},_changeHour:function(t,e){this._changeTime(t,e,"hour","hours")},_changeMinute:function(t,e){this._changeTime(t,e,"minute","minutes")},_changeSecond:function(t,e){this._changeTime(t,e,"second","seconds")},__isUnlimitMode:function(){return this.options.unlimit&&(this.__unlimit||this.options.unlimit.isSame(this.data.date))&&!0||!1},_renderYearPicker:function(a){function n(e,i,n,r){var d=e.find(".year-header .year-header-title"),o=e.find(".year-body .year-body-content"),c=o.data(),u=n.get("year");c.start=(c.start||u-u%r)+a*r,c.end=c.start+r-1,d.text(c.start+" - "+c.end),o.empty();for(var m=c.start;m<=c.end;m++)n.year(m),t("<span>").text(m).attr("data-value",m).attr("bx-click",l({unit:"year",value:n.format(h),pattern:h})).addClass(s||i.get("year")!==n.get("year")?"":"active").appendTo(o)}a=a||0;var r=this.data.date,s=this.__isUnlimitMode();s&&(r=i().startOf("day"));var d=this.__cursor||0,o=this.$element.find(".year");return e.each(o,function(e,a){var s=i(r).add(a-d,"months");n(t(e),r,s,p)}),this},_renderMonthPicker:function(){function a(i,a,n){var s=(i.find(".month-header .month-header-title").text(n.get("year")),i.find(".month-body .month-body-content").empty()),d=function(){for(var t=[],e=1;12>=e;e++)t.push(10>e?"0"+e:e);return t}();e.each(d,function(e,i){n.month(i),t("<span>").text(e).attr("data-value",n.format(c)).addClass(r||n.get("year")!==a.get("year")||n.get("month")!==a.get("month")?"":"active").attr("bx-click",l({unit:"month",value:n.format(c),pattern:c})).appendTo(s)})}var n=this.data.date,r=this.__isUnlimitMode();r&&(n=i().startOf("day"));var s=this.__cursor||0,d=this.$element.find(".month");return e.each(d,function(e,r){var d=i(n).add(r-s,"months");a(t(e),n,d)}),this},_renderDatePicker:function(a,n){function r(t,e,i){t.find(".date-header .date-header-title").text(i.format("YYYY - MM"))}function s(e,a,n,r){for(var s=e.find(".date-body .date-body-content").empty(),c=i(n).date(1).day(),f=0;c>f;f++)s.append('<span class="inactive">');for(var p=n.daysInMonth(),_=1;p>=_;_++)n.date(_),t("<span>").text(_).addClass(d(n)?"hover":"").addClass(o(m,a,n,_)?"active":"").addClass(h(n,r)?"disabled":"").attr("bx-click",l({unit:"date",value:n.format(u),pattern:u})).appendTo(s)}function d(t){return t.isSame(i(),"day")}function o(t,e,i){return!t&&i.isSame(e,"day")}function h(t,a){if(!a.length)return!1;for(var n,r,s=i(t).startOf("day"),d=0;d<a.length;d+=2){if(n=a[d]&&i(a[d],e.isString(a[d])&&f),r=a[d+1]&&i(a[d+1],e.isString(a[d+1])&&f),n&&r){var o=[n,r];n=i.min(o[0],o[1]),r=i.max(o[0],o[1])}if(n&&r&&s.diff(n,"days")>=0&&s.diff(r,"days")<=0)return!1;if(n&&!r&&s.diff(n,"days")>=0)return!1;if(!n&&r&&s.diff(r,"days")<=0)return!1;if(!n&&!r)return!1}return!0}a=a||this.data.date||i(),n=n||this.__cursor||0;var c=this.options.range,m=this.__isUnlimitMode();m&&(a=i().startOf("day"));var p=this.$element.find(".date");return e.each(p,function(e,d){var o=i(a).add(d-n,"months"),h=t(e);r(h,a,o,c),s(h,a,o,c)}),this},_renderTimePicker:function(){var t=i(this.data.date),e=this.$element.find(".hour-minute-second input");return e.eq(0).val(t.format("HH")),e.eq(1).val(t.format("mm")),e.eq(2).val(t.format("ss")),this},_unlimit:function(){var e=this.options.unlimit;this.__unlimit=e;var i=e.isSame(this.data.date),a=t.Event((i?"unchange":"change")+d);this.trigger(a,[e,"date"]),this._renderYearPicker()._renderMonthPicker()._renderDatePicker()},destroy:function(){this.$manager.undelegate(this.$element,this)}}),s});