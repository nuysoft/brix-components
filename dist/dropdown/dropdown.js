define(["jquery","underscore","components/base","brix/event","./dropdown.tpl.js"],function(e,t,n,a,l){function i(e){return e&&e.element&&"select"!==e.element.nodeName.toLowerCase()?new o:void 0}function o(){}var r=".dropdown";return t.extend(i.prototype,n.prototype,{options:{label:null,value:null,data:[],disabled:null},init:function(){this.$element=e(this.element).hide(),this.$manager=new a("bx-");var t=this.options;t.data.length?(this._preFilterData(),this._fillSelect()):t.data=this._parseDataFromSelect(this.$element),t.disabled=this.$element.prop("disabled"),null!==t.value&&this.$element.val(t.value);var n=this.$element.find("option:selected");return{label:n.text(),value:n.attr("value")}},render:function(){var n=this._fillData();this.$relatedElement=e(t.template(l)(n)).insertBefore(this.$element),this.$manager.delegate(this.$element,this),this.$manager.delegate(this.$relatedElement,this),this._responsive(),this._autoHide()},toggle:function(){return this.$relatedElement.toggleClass("open"),this},show:function(){return this.$relatedElement.addClass("open"),this},hide:function(){return this.$relatedElement.removeClass("open"),this},val:function(e){var n=this.$element.val();if(void 0===e)return n;var a;return t.isObject(e)?a=e:t.each(this.options.data,function(t){t.value==e&&(a=t),t.selected=t.value==e}),a.name=this.$element.attr("name"),""+a.value===n?this:(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(a.label),this.$element.val(a.value),this.$relatedElement.find('ul.dropdown-menu li:has([value="'+n+'"])').removeClass("active"),this.$relatedElement.find('ul.dropdown-menu li:has([value="'+a.value+'"])').addClass("active"),this.trigger("change"+r,a),this.$element.triggerHandler("change"),this)},data:function(n){this.options.data=n,this._fillSelect();var a=this.$relatedElement.find("ul.dropdown-menu"),i=e(t.template(l)(this._fillData())).find("ul.dropdown-menu");a.replaceWith(i),this.$manager.delegate(this.$element,this)},select:function(t){var n=e(t.currentTarget),a={label:n.text(),value:n.attr("value")||n.text()};this.val(a),this.toggle(),n.parent().addClass("active").siblings().removeClass("active")},_parseDataFromSelect:function(n){function a(e){return t.map(e,function(e){return l(e)})}function l(t){var n=e(t);return n.hasClass("divider")?"divider":{label:n.text(),value:n.attr("value"),selected:n.prop("selected")}}var i=t.filter(n.children(),function(e){return/optgroup|option/i.test(e.nodeName)});return t.map(i,function(t){var n=e(t);return/optgroup/i.test(t.nodeName)?{label:n.attr("label"),children:a(n.children())}:l(t)})},_fillData:function(){var n=this;return t.extend({data:this.options.data,disabled:this.options.disabled||this.$element.prop("disabled")},function(){n.options.value&&n.$element.val(n.options.value);var t=n.$element.prop("selectedIndex"),a=e(n.element.options[-1!==t?t:0]);return{label:a.text(),value:a.attr("value")}}())},_fillSelect:function(){function n(t){return e("<option>").attr("value",t.value).prop("selected",t.selected).text(t.label)}var a=this.$element.empty();t.each(this.options.data,function(l){if(l.children&&l.children.length){var i=e("<optgroup>").attr("label",l.label);t.each(l.children,function(e){n(e).appendTo(i)}),i.appendTo(a)}else n(l).appendTo(a)})},_preFilterData:function(){this.options.data.length&&t.each(this.options.data,function(e,n,a){t.isObject(e)||(a[n]={label:e,value:e})})},_responsive:function(){var t=e(window),n=this.$relatedElement,a=n.find("ul.dropdown-menu");e(window).on("scroll",function(){var e=n.offset(),l=e.top-t.scrollTop(),i=t.scrollTop()+t.height()-e.top-n.outerHeight(),o=i>=l?"button":"top";switch(o){case"button":a.css("max-height",l-10);break;case"top":a.css("max-height",i-10)}})},_autoHide:function(){var t=this,n="click.dropdown_autohide_"+this.clientId;e(document.body).off(n).on(n,function(e){t.$relatedElement.has(e.target).length||t.hide()})},destroy:function(){var t="click.dropdown_autohide_"+this.clientId;e(document.body).off(t)}}),t.extend(o.prototype,i.prototype,{init:function(){this.$element=e(this.element),this.$relatedElement=this.$element,this.$manager=new a("bx-")},render:function(){{var e=this;new a("bx-")}e.options.value&&e.val(e.options.value),this.$manager.delegate(this.$element,this),this._autoHide()},val:function(n){var a=this,l=function(){var e=a.$element.find("ul.dropdown-menu > li.active > a");return e.attr("value")||e.text()}();if(void 0===n)return l;var i;if(t.isObject(n))i=n;else{var o=a.$element.find("ul.dropdown-menu > li");t.each(o,function(t){var a=e(t).removeClass("active"),l=a.find("> a"),o=l.attr("value"),r=l.text();(o||r)==n&&(i={label:r,value:o||r},a.addClass("active"))})}return i.name=this.$element.attr("name"),i.value===l?this:(this.$element.find("button.dropdown-toggle > span.dropdown-toggle-label").text(i.label),this.trigger("change"+r,i),this)},_fillSelect:function(){},_fillData:function(){var n=this;return t.extend({data:this.options.data,disabled:this.options.disabled},function(){n.options.value&&n.$element.val(n.options.value);var a,l=n.$element.find("ul.dropdown-menu > li");return t.each(l,function(t){var l=e(t).removeClass("active"),i=l.find("> a"),o=i.attr("value"),r=i.text();(o||r)==n.options.value&&(a={label:r,value:o||r},l.addClass("active"))}),a||{label:void 0,value:void 0}}())}}),i});