define(["jquery","underscore","components/base","brix/event","./dropdown.tpl.js","css!./dropdown.css"],function(e,t,n,i,o){function a(e){return e&&e.element&&"select"!==e.element.nodeName.toLowerCase()?new l:void 0}function l(){}var r=".dropdown";return t.extend(a.prototype,n.prototype,{options:{value:"",data:[]},init:function(){this.$element=e(this.element).hide(),this.options.data.length?this._fill():this.options.data=this._parseData(this.$element)},render:function(){var n=this,a=new i,l=t.extend({data:this.options.data,disabled:this.options.disabled||this.$element.prop("disabled")},function(){n.options.value&&n.$element.val(n.options.value);var t=n.$element.prop("selectedIndex"),i=e(n.element.options[-1!==t?t:0]);return{label:i.text(),value:i.attr("value")}}());this.$relatedElement=e(t.template(o)(l)).insertAfter(this.$element),a.delegate(this.$element,this),a.delegate(this.$relatedElement,this),this._autoHide()},toggle:function(){return this.$relatedElement.toggleClass("open"),this},show:function(){return this.$relatedElement.addClass("open"),this},hide:function(){return this.$relatedElement.removeClass("open"),this},val:function(n){var i=this,o=function(){var t=i.$element.prop("selectedIndex");return e(i.element.options[-1!==t?t:0]).attr("value")}();if(void 0===n)return o;var a;return t.isObject(n)?a=n:t.each(this.options.data,function(e){e.value==n&&(a=e),e.selected=e.value==n}),a.name=this.$element.attr("name"),a.value===o?this:(this.$relatedElement.find("button.dropdown-toggle > span.dropdown-toggle-label").text(a.label),this.$element.val(a.value),this.$relatedElement.find('ul.dropdown-menu li:has([value="'+o+'"])').removeClass("active"),this.$relatedElement.find('ul.dropdown-menu li:has([value="'+a.value+'"])').addClass("active"),this.trigger("change"+r,a),this.$element.triggerHandler("change"),this)},_select:function(t){var n=e(t.currentTarget),i={label:n.text(),value:n.attr("value")||n.text()};this.val(i),this.toggle(),n.parent().addClass("active").siblings().removeClass("active")},_parseData:function(n){var i=this,o=t.filter(n.children(),function(e){return/optgroup|option/i.test(e.nodeName)});return t.map(o,function(t){var n=e(t);return/optgroup/i.test(t.nodeName)?{label:n.attr("label"),children:i._parseOptions(n.children())}:i._parseOption(t)})},_parseOptions:function(e){var n=this;return t.map(e,function(e){return n._parseOption(e)})},_parseOption:function(t){var n=e(t);return n.hasClass("divider")?"divider":{label:n.text(),value:n.attr("value"),selected:n.prop("selected")}},_fill:function(){var n=this,i=this.$element.hide().empty();t.each(this.options.data,function(o){if(o.children&&o.children.length){var a=e("<optgroup>").attr("label",o.label);t.each(o.children,function(e){n._genOption(e).appendTo(a)}),a.appendTo(i)}else n._genOption(o).appendTo(i)})},_genOption:function(t){return e("<option>").attr("value",t.value).prop("selected",t.selected).text(t.label)},_responsive:function(){var t=e(window),n=this.$relatedElement,i=n.find("ul.dropdown-menu");e(window).on("scroll",function(){var e=n.offset(),o=e.top-t.scrollTop(),a=t.scrollTop()+t.height()-e.top-n.outerHeight(),l=a>=o?"button":"top";switch(l){case"button":i.css("max-height",o-10);break;case"top":i.css("max-height",a-10)}})},_autoHide:function(){var t=this,n="click.dropdown_autohide_"+this.clientId;e(document.body).off(n).on(n,function(e){t.$relatedElement.has(e.target).length||t.hide()})},destroy:function(){var t="click.dropdown_autohide_"+this.clientId;e(document.body).off(t)}}),t.extend(l.prototype,a.prototype,{init:function(){this.$element=e(this.element),this.$relatedElement=this.$element},render:function(){var e=new i("bx-");e.delegate(this.$element,this);var t=this;this.$element.on("click","ul.dropdown-menu > li > a",function(e){t._select(e)}),this._autoHide()},toggle:function(){return this.$element.toggleClass("open"),this},show:function(){return this.$element.addClass("open"),this},hide:function(){return this.$element.removeClass("open"),this},val:function(n){var i=this,o=function(){var e=i.$element.find("ul.dropdown-menu > li.active > a");return e.attr("value")||e.text()}();if(void 0===n)return o;var a;if(t.isObject(n))a=n;else{var l=i.$element.find("ul.dropdown-menu > li");t.each(l,function(t,i){var o=e(t).removeClass("active"),l=o.find("> a"),r=l.attr("value"),s=l.text();(r||s)==n&&(a={label:s,value:r||s},o.addClass("active"))})}return a.name=this.$element.attr("name"),a.value===o?this:(this.$element.find("button.dropdown-toggle > span.dropdown-toggle-label").text(a.label),this.trigger("change"+r,a),this)},_select:function(t){var n=e(t.currentTarget),i={label:n.text(),value:n.attr("value")||n.text()};this.val(i),this.toggle(),n.parent().addClass("active").siblings().removeClass("active")},_autoHide:function(){var t=this,n="click.dropdown_autohide_"+this.clientId;e(document.body).off(n).on(n,function(e){t.$element.has(e.target).length||t.hide()})},destroy:function(){var t="click.dropdown_autohide_"+this.clientId;e(document.body).off(t)}}),a});